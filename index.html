<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conference Deadlines</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://code.highcharts.com/11.3/highcharts.js"></script>
    <script src="https://code.highcharts.com/gantt/11.3/modules/gantt.js"></script>
    <style>
        html {
            overflow: hidden;
            height: 100%;
            font-family: "Lato", sans-serif !important;
            font-weight: 400 !important;
            font-style: normal !important;
        }

        body {
            height: 100%;
            overflow: auto;
        }

        .tag {
            font-size: 0.5rem !important;
        }

        a:hover {
            color: #485fc7 !important;
        }

        .tabs {
            margin-bottom: -1.2rem !important;
            position: sticky;
            z-index: 1001;
            background-color: white;
            font-size: 0.75rem !important;
        }

        .tabs a {
            border-bottom-width: 2px !important;
        }

        footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 1.5rem;
            text-align: center;
            background-color: white;
            border-top: 1px solid #dbdbdb;
        }

        #container {
            position: absolute;
            top: 1.5rem;
            height: calc(100dvh - 3rem);
            height: calc(100% - 3rem);
            width: 100%;
            overflow-x: scroll !important;
            transition: visibility 0.5s, opacity 0.5s linear;
        }

        #container .highcharts-treegrid-node-expanded {
            pointer-events: none;
        }

        .highcharts-scrolling-parent {
            overflow-y: hidden !important;
        }

        .highcharts-scrollable-mask {
            fill-opacity: 1 !important;
            fill: #FFFFF0 !important;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20vw;
        }

        #mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
    </style>
</head>

<body>
    <div class="tabs is-centered">
        <ul>
            <li onclick="openTab('a-star')" id="a-star-tab" class="is-active is-loading"><a>A* Conferences</a></li>
            <li onclick="openTab('a')" id="a-tab"><a>A Conferences</a></li>
            <li onclick="openTab('b')" id="b-tab"><a>B Conferences</a></li>
        </ul>
    </div>
    <div id="mask"><progress id="loading" class="progress is-small is-primary" max="100">0%</progress></div>
    <div id="container"></div>
    <footer>Made with ❤️ by <a href="https://github.com/CaptainIRS">CaptainIRS</a></footer>
    <script>
        let j = 0;
        const hideMask = () => {
            document.getElementById('mask').style.visibility = 'hidden';
            document.getElementById('mask').style.opacity = 0;
            document.getElementById('container').style.visibility = 'visible';
            document.getElementById('container').style.opacity = 1;
        }
        const showMask = () => {
            document.getElementById('mask').style.visibility = 'visible';
            document.getElementById('mask').style.opacity = 1;
            document.getElementById('container').style.visibility = 'hidden';
            document.getElementById('container').style.opacity = 0;
        }
        const appendToSeries = (seriesData, avg, std_dev, min, max, name, parent) => {
            let color = '';
            if (name.includes('Abstract')) {
                color = 'rgba(148, 0, 211, 0.7)';
            } else if (name.includes('Submission')) {
                color = 'rgba(75, 0, 130, 0.7)';
            } else if (name.includes('Notification')) {
                color = 'rgba(0, 0, 255, 0.7)';
            } else if (name.includes('Final')) {
                color = 'rgba(0, 255, 0, 0.7)';
            } else if (name.includes('Start')) {
                color = 'rgba(255, 127, 0, 0.7)';
            } else if (name.includes('End')) {
                color = 'rgba(255, 0, 0, 0.7)';
            }
            if (avg) {
                if (std_dev != -1) {
                    seriesData.data.push({
                        'deadline': name,
                        'name': name,
                        'start': Date.UTC(avg.year, avg.month, avg.day) - 2 * std_dev * 24 * 60 * 60 * 1000,
                        'end': Date.UTC(avg.year, avg.month, avg.day) + 2 * std_dev * 24 * 60 * 60 * 1000,
                        color: 'rgba(140, 140, 140, 0.7)',
                        pointWidth: 2,
                        'parent': parent,
                        id: `${parent}children`,
                        y: j
                    })
                    seriesData.data.push({
                        'deadline': name,
                        'name': name,
                        'start': Date.UTC(min.year, min.month, min.day),
                        'end': Date.UTC(max.year, max.month, max.day),
                        'parent': parent,
                        color: color,
                        id: `${parent}children`,
                        y: j
                    })
                    return true;
                } else if (std_dev) {
                    seriesData.data.push({
                        'deadline': name,
                        'name': name,
                        'start': Date.UTC(avg.year, avg.month, avg.day) - 2 * 30 * 24 * 60 * 60 * 1000,
                        'end': Date.UTC(avg.year, avg.month, avg.day) + 2 * 30 * 24 * 60 * 60 * 1000,
                        color: 'rgba(140, 140, 140, 0.7)',
                        pointWidth: 2,
                        'parent': parent,
                        id: `${parent}children`,
                        y: j
                    })
                    seriesData.data.push({
                        'deadline': name,
                        'name': name,
                        'start': Date.UTC(min.year, min.month, min.day) - 30 * 24 * 60 * 60 * 1000,
                        'end': Date.UTC(max.year, max.month, max.day) + 30 * 24 * 60 * 60 * 1000,
                        color: color,
                        'parent': parent,
                        id: `${parent}children`,
                        y: j
                    })
                    return true;
                }
            }
            return false;
        }

        const openTab = (confType) => {
            showMask();
            j = 0;
            document.querySelector('.is-active').classList.remove('is-active');
            document.getElementById(`${confType}-tab`).classList.add('is-active');
            fetch('/details.json').then(response => response.json()).then(data => {
                let seriesData = {
                    'name': 'Deadlines',
                    'data': [],
                    'turboThreshold': 0,
                }
                plots = 0;
                const type = confType == 'a-star' ? 'A*' : confType.toUpperCase();
                let categories = [];
                for (let i = 0; i < data.length; i++) {
                    if (data[i].rank != type) {
                        continue;
                    }
                    let deadlines = [];
                    let addedPlots = 0;
                    let hasSeries = false;
                    let minDate = null, maxDate = null;
                    for (let [avg, std] of [
                        [data[i].abstract_registration_dues_avg, data[i].abstract_registration_dues_std_dev],
                        [data[i].submission_deadlines_avg, data[i].submission_deadlines_std_dev],
                        [data[i].notification_dues_avg, data[i].notification_dues_std_dev],
                        [data[i].final_version_dues_avg, data[i].final_version_dues_std_dev],
                        [data[i].start_dates_avg, data[i].start_dates_std_dev],
                        [data[i].end_dates_avg, data[i].end_dates_std_dev]
                    ]) {
                        if (avg) {
                            date = Date.UTC(avg.year, avg.month, avg.day);
                            if (std == -1) {
                                std = 30;
                            }
                            stdDevMin = Date.UTC(avg.year, avg.month, avg.day) - 2 * std * 24 * 60 * 60 * 1000;
                            stdDevMax = Date.UTC(avg.year, avg.month, avg.day) + 2 * std * 24 * 60 * 60 * 1000;

                            if (minDate == null || minDate > stdDevMin) {
                                minDate = stdDevMin;
                            }
                            if (maxDate == null || maxDate < stdDevMax) {
                                maxDate = stdDevMax;
                            }
                        }
                    }
                    seriesData.data.push({
                        'acronym': data[i].acronym,
                        'name': data[i].title,
                        'id': `${data[i].acronym}main`,
                        color: 'rgba(0, 0, 0, 0.7)',
                        start: minDate,
                        end: maxDate,
                        pointWidth: 5,
                        y: j++,
                    });
                    addedPlots += 1;
                    deadlines.push('Overall');
                    // abstract_registration_dues_avg
                    hasSeries = appendToSeries(seriesData, data[i].abstract_registration_dues_avg, data[i].abstract_registration_dues_std_dev, data[i].abstract_registration_dues_min, data[i].abstract_registration_dues_max, 'Abstract Registration Due', data[i].acronym)
                    if (hasSeries) {
                        addedPlots += 1;
                        deadlines.push('Abstract Registration');
                        j++;
                    }
                    // submission_deadlines_avg
                    hasSeries = appendToSeries(seriesData, data[i].submission_deadlines_avg, data[i].submission_deadlines_std_dev, data[i].submission_deadlines_min, data[i].submission_deadlines_max, 'Submission Deadline', data[i].acronym)
                    if (hasSeries) {
                        addedPlots += 1;
                        deadlines.push('Submission');
                        j++;
                    }
                    // notification_dues_avg
                    hasSeries = appendToSeries(seriesData, data[i].notification_dues_avg, data[i].notification_dues_std_dev, data[i].notification_dues_min, data[i].notification_dues_max, 'Notification Due', data[i].acronym)
                    if (hasSeries) {
                        addedPlots += 1;
                        deadlines.push('Notification');
                        j++;
                    }
                    // final_version_dues_avg
                    hasSeries = appendToSeries(seriesData, data[i].final_version_dues_avg, data[i].final_version_dues_std_dev, data[i].final_version_dues_min, data[i].final_version_dues_max, 'Final Version Due', data[i].acronym)
                    if (hasSeries) {
                        addedPlots += 1;
                        deadlines.push('Final Version');
                        j++;
                    }
                    // start_dates_avg
                    hasSeries = appendToSeries(seriesData, data[i].start_dates_avg, data[i].start_dates_std_dev, data[i].start_dates_min, data[i].start_dates_max, 'Start Date', data[i].acronym)
                    if (hasSeries) {
                        addedPlots += 1;
                        deadlines.push('Start');
                        j++;
                    }
                    // end_dates_avg
                    hasSeries = appendToSeries(seriesData, data[i].end_dates_avg, data[i].end_dates_std_dev, data[i].end_dates_min, data[i].end_dates_max, 'End Date', data[i].acronym)
                    if (hasSeries) {
                        addedPlots += 1;
                        deadlines.push('End');
                        j++;
                    }

                    plots += addedPlots;

                    let newCategories = [];
                    for (let k = 0; k < deadlines.length; k++) {
                        newCategories.push({
                            deadline: deadlines[k],
                        });
                    }
                    let k = 0;
                    let titleStrings = data[i].title.match(/\b[\w\s,-/]{35,}?(?=[\s])|.+$/g);
                    if (k != newCategories.length) {
                        newCategories[k].title = titleStrings[0];
                        newCategories[k++].url = `https://www.google.com/search?q=${data[i].title}`;
                    }
                    if (k != newCategories.length && titleStrings.length > 1) {
                        newCategories[k].title = titleStrings[1] + (titleStrings.length > 2 ? '&hellip;' : '');
                        newCategories[k++].url = `https://www.google.com/search?q=${data[i].title}`;
                    }
                    if (k != newCategories.length) newCategories[k++].acronym = data[i].acronym;
                    let tags = data[i].tags.join(', ');
                    if (tags) {
                        let tagStrings = tags.match(/\b[\w\s,-/]{35,}?(?=[,])|.+$/g);
                        if (k != newCategories.length) newCategories[k++].tags = '<span class="tag">' + tagStrings[0].split(', ').join('</span> <span class="tag">') + '</span>';
                        if (k != newCategories.length && tagStrings.length > 1) newCategories[k++].tags = '<span class="tag">' + (tagStrings[1].substring(2)).split(', ').join('</span> <span class="tag">') + '</span>' + (tagStrings.length > 2 ? '&nbsp;&hellip;' : '');
                    }
                    categories.push(...newCategories);
                }

                const chart = Highcharts.ganttChart('container', {
                    yAxis: {
                        staticScale: 20,
                        grid: {
                            columns: [{
                                overflow: 'allow',
                                labels: {
                                    formatter: function () {
                                        if (this.value.acronym) {
                                            return this.value.acronym;
                                        } else if (this.value.title) {
                                            console.log(this.value.url);
                                            return `<b><a target="_blank" href="${this.value.url}">${this.value.title}</a></b>`;
                                        } else if (this.value.tags) {
                                            return this.value.tags;
                                        }
                                    },
                                    useHTML: true,
                                }
                            }, {
                                labels: {
                                    formatter: function () {
                                        if (this.value.deadline == 'Overall') {
                                            return `<b>${this.value.deadline}</b>`;
                                        }
                                        return this.value.deadline;
                                    }
                                }
                            }],
                        },
                        categories: categories,
                    },
                    xAxis: [{
                        grid: {
                            cellHeight: 20,
                            enabled: true,
                        }, margin: 10, maxPadding: 0
                    }, {
                        grid: {
                            cellHeight: 20,
                            enabled: true,
                        }, margin: -15, maxPadding: 0
                    }],
                    series: [seriesData],
                    chart: {
                        width: Math.max(1200, window.innerWidth),
                        scrollablePlotArea: {
                            minHeight: plots * 20 + 150,
                        },
                        style: {
                            fontFamily: 'Lato',
                            fontWeight: 400,
                            fontStyle: 'normal',
                        },
                        events: {
                            load() {
                                let chart = this,
                                    ticks = chart.yAxis[0].brokenAxis.axis.ticks;
                                for (let i = 0; i < categories.length - 1; i++) {
                                    if (categories[i + 1].deadline != 'Overall') {
                                        ticks[i].mark.hide();
                                    }
                                }
                                setTimeout(hideMask, 1000);
                            }
                        }
                    }
                });
            });
        }

        openTab('a-star');
    </script>
</body>

</html>